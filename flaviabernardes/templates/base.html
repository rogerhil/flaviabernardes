{% load staticfiles %}
{% load cropping %}

<html>
    <head>
        <!-- jQuery library (served from Google) -->
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script src="http://code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
        <script src="{% static 'js/jquery.bxslider.js' %}"></script>
        <script src="{% static 'js/jquery.cookie.js' %}"></script>
        <link href="{% static 'css/jquery.bxslider.css' %}" rel="stylesheet" />
        <link href="{% static 'css/base.css' %}" rel="stylesheet" />

        <script>
            var csrftoken = $.cookie('csrftoken');

            function csrfSafeMethod(method) {
                // these HTTP methods do not require CSRF protection
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }

            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });

            function login() {
                if (location.hash != '#login') return;
                $.ajax({
                    url: '/login/json/',
                    success: function (data) {
                        if (!data.success) {
                            alert(data.message);
                            return
                        }
                        if (data.data.authenticated) {
                            return;
                        }
                        $("#cover").html(data.data.content);
                        $('#cover').fadeIn();
                        $('#login button').click(loginSubmit);
                    }
                });
            }
            function logout() {
                if (location.hash != '#logout') return;
                $.ajax({
                    url: '/logout/json/',
                    success: function (data) {
                        if (!data.success) {
                            alert(data.message);
                            return
                        }
                        window.location = window.location.href.split('#')[0];
                    }
                });
            }

            function setupLoginLogout() {
                login();
                logout();
            };

            window.onhashchange = setupLoginLogout;
            setupLoginLogout();

            function loginSubmit(e) {
                e.preventDefault();
                var formData = {
                    username: $('#login input[name=username]').val(),
                    password: $('#login input[name=password]').val(),
                    csrfmiddlewaretoken: $('#login input[name=csrfmiddlewaretoken]').val(),
                };
                $.ajax({
                    url: '/login/json/',
                    type: 'post',
                    dataType: 'json',
                    data: formData,
                    success: function (data) {
                        if (!data.success) {
                            alert(data.message);
                            return
                        }
                        if (data.data) {
                            $("#cover").html(data.data.content);
                            $('#cover').fadeIn();
                            $('#login button').click(loginSubmit);
                            $('ul.errorlist').effect('bounce');
                        } else {
                            window.location = window.location.href.split('#')[0];
                        }

                    }
                });
            }
        </script>

        <style>
            {% if user.is_authenticated %}
                #site {
                    *border: 1px dashed red;
                    background-color: #fff;
                }
                body {
                    background-color: #fff8f8;
                }
                #header .content {
                    background-color: #fff8f8 !important;
                }
            {% endif %}
        </style>
        {% block extrastyle %}{% endblock %}
    </head>
    <body>
        <div id="cover"></div>
        {% block site %}
            <section id="header">
                <div style="position: absolute; width: 100%; height: 210px;">
                    <div id="logo-home">
                        Flavia Bernardes
                    </div>
                    <div class="content">
                        <div class="transp transp-top" style="">
                            <section id="menu">
                                <a href="{% url 'artworks' %}"{% if request.resolver_match.url_name == "artworks" %} class="active"{% endif %}>Artworks</a>
                                <a href="{% url 'about' %}"{% if request.resolver_match.url_name == "about" %} class="active"{% endif %}>About</a>
                                <a href="{% url 'blog' %}">Blog</a>
                                <a href="#">Contact</a>
                                <div class="clear"></div>
                            </section>
                        </div>
                    </div>
                </div>
                <div class="home-overlay"></div>
            </section>
            <div id="site">
                <section id="container">
                    {% block container %}
                    {% endblock %}
                    <div class="clear"></div>
                </section>
                <div class="clear"></div>
                <section id="footer">
                    <div class="copyrights">&#9400 Flavia Bernardes, 2015. All rights reserved.</div>
                    <div class="social"></div>
                </section>
            </div>
        {% endblock %}
    </body>
    <script>
        $(window).ready(function () {
            if ($.browser.chrome) {
                $("#logo-home").css("margin", "-10px auto 28px auto");
            }
            $(window).scroll(function () {
                if ($(window).scrollTop() > 110) {
                    $('.content').addClass('menu-fixed');
                } else {
                    $('.content').removeClass('menu-fixed');
                }
            });
            $('#logo-home').click(function () {
                window.location.replace('/');
            });
        });
    </script>
</html>
