{% extends 'base.html' %}
{% load staticfiles %}
{% load cropping %}

{% block ogtype %}article{% endblock %}

{% block extrastyle %}
    <link href="{% static 'css/blog.css' %}" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
{% endblock %}

{% block container-large %}
    <div id="full-view">

    </div>
    <div id="artworks">
        {% for artwork in artwork_list %}
            <div class="grid artwork" artwork="{{ artwork.id }}">
                <figure class="effect-lily" style="background-image: url({% cropped_thumbnail artwork 'thumbnail' scale=1 %});" alt="{{ artwork.name }}" title="{{ artwork.name }}">
                    <div class="dark">
                        <figcaption>
                            <div class="description">
                                <h2 class="title">{{ artwork.name }}</h2>
                                <br>
                                <p class="details">
                                    {{ artwork.type }}, {{ artwork.width }}x{{ artwork.height }}cm, {{ artwork.year }}
                                </p>
                            </div>
                            <a href="#{{ artwork.id }}">View more</a>
                        </figcaption>
                    </div>
                </figure>
            </div>
        {% endfor %}
    </div>
    <div class="clear"></div>

    <script src="{% static 'js/jquery.ba-hashchange.min.js' %}"></script>

    <script>
        var preview_urls = {
            {% for artwork in artwork_list %}
                {{ artwork.id }}: {original: '{% cropped_thumbnail artwork 'full_preview' width=960 %}'},
            {% endfor%}
        };
        var $currentOpened;

        $(window).ready(function () {
            $(window).hashchange();
        });

        $(window).hashchange(function() {
            var hash = window.location.hash;
            if (!hash) return;
            hash = hash.replace('#', '');
            if (!hash) return;
            var $artwork = $('#artworks div.artwork[artwork=' + hash + ']');
            if (!$artwork.length) return;
            showArtwork($artwork);
        });

        //$('#artworks div.artwork').click(function (e) {
        function showArtwork($artwork) {
            var url = preview_urls[$artwork.attr('artwork')].original;
            var title = $artwork.find('.title').text();
            var details = $artwork.find('.details').text();
            $("#full-view").append('<img src="' + url + '" alt="' + title + '" title="' + title + '" />');
            $("#full-view").append('<div class="artwork-preview-details"><p class="title">' + title + '</p><p>' + details + '</p></div>');
            $("#full-view").append('<div id="close-artwork-preview" class="fa fa-times" title="Close" alt="Close"></div>');
            $("#full-view").append('<div id="right-artwork-preview" class="fa fa-caret-right" title="Next" alt="Next"></div>');
            $("#full-view").append('<div id="left-artwork-preview" class="fa fa-caret-left" title="Previous" alt="Previous"></div>');
            $("#full-view").css('z-index', 9990);
            $("#full-view").fadeIn(1000);
            $('#cover img').hide();
            $('#cover').fadeIn();
            $("#footer").fadeOut();
            $(".banner").hide();
            $(".page-content1").hide();
            $(".page-content2").hide();
            $(".page-content3").hide();
            $("#artworks").hide();
            $(".site-middle").hide();
            $(".container-bottom").hide();
            $currentOpened = $artwork;

            $('#close-artwork-preview').click(closeFullPreview);
            $('#full-view').click(closeFullPreview);

            $('#full-view *').click(function (e) {
                e.stopPropagation();
                e.preventDefault();
            });

            $('#right-artwork-preview').click(function (e) {
                e.stopPropagation();
                e.preventDefault();
                moveRight();
            });
            $('#left-artwork-preview').click(function (e) {
                e.stopPropagation();
                e.preventDefault();
                moveLeft();
            });
            setupArrows();
        }

        var closeFullPreview = function () {
            window.location.hash = '';
            $("#full-view").fadeOut(1000, function () {
                $(this).html('');
            });
            $('#cover').fadeOut();
            $('#cover img').fadeIn(5000);
            $("#footer").fadeIn();
            //$("#artworks").css('visibility', 'visible');
            $("#artworks").fadeIn();
            $(".site-middle").fadeIn();
            $(".container-bottom").fadeIn();
            $(".banner").fadeIn();
            $(".page-content1").show();
            $(".page-content2").show();
            $(".page-content3").show();
            $(window).trigger('scroll');
        }

        $(document).keydown(function(e) {
            var $item;
            switch (e.keyCode) {
                case 27:
                    closeFullPreview();
                    break;
                case 37:  // left
                    moveLeft();
                    break;
                case 39:  // right
                    moveRight();
                    break;
            }
        });

        function setupArrows() {
            if (!$currentOpened.prev().length) {
                $('#left-artwork-preview').hide();
            } else {
                $('#left-artwork-preview').show();
            }
            if (!$currentOpened.next().length) {
                $('#right-artwork-preview').hide();
            } else {
                $('#right-artwork-preview').show();
            }
        }

        function moveLeft() {
            $item = $currentOpened.prev();
            if ($item.length) {
                $("#full-view").html('');
                window.location.hash = $item.attr('artwork');
                $("#full-view img").hide();
                $("#full-view img").fadeIn();
            }
            setupArrows();
        }

        function moveRight() {
            $item = $currentOpened.next();
            if ($item.length) {
                $("#full-view").html('');
                window.location.hash = $item.attr('artwork');
                $("#full-view img").hide();
                $("#full-view img").fadeIn();
            }
            setupArrows();
        }

        $("#artworks").sortable({
            stop: function (e, ui) {
                var data = [];
                $("#artworks .artwork").each(function () {
                    data.push($(this).attr('artwork'));
                });
                $.ajax({
                    url: '/artworks/sort/',
                    type: 'POST',
                    dataType: 'json',
                    data: {data: data},
                    success: function (result) {
                        console.log(result);
                        if (!result.success) {
                            alert('Something went wrong while trying to sort the artworks. Please contact Rogerio: ' + result.message);
                        }
                    }
                })
            }
        });
        $("#thumbnails ul").disableSelection();

    </script>
{% endblock %}
