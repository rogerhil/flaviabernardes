tinymce.PluginManager.add('imageupload', function(editor, url) {
    // Add a button that opens a window
    editor.addButton('imageupload', {
        text: 'Image Upload',
        icon: false,
        onclick: function() {
            // Open window
            editor.windowManager.open({
                title: 'Image Upload',
                body: [],
                width: 800,
                height: 500,
                onsubmit: function(e) {
                    //
                }
            });

            loadUploadedImages(editor);

            $('.mce-container-body.mce-window-body .mce-abs-layout').append(
                $('<form id="upload-form" style="padding: 10px;"><input type="file" name="file" /></form>')
            );

            $('#upload-form input[name=file]').change(function () {
                $.ajax({
                    url: '/admin/cms/image/upload/',
                    type: 'post',
                    dataType: 'json',
                    data: new FormData($('#upload-form')[0]),
                    success: function (data) {
                        loadUploadedImages(editor);
                    },
                    cache: false,
                    contentType: false,
                    processData: false
                });
            });
        }
    });
});

function loadUploadedImages(editor) {
    if (!$('#uploaded-images').length) {
        $('.mce-container-body.mce-window-body').append('<div id="uploaded-images" style="margin-top: 30px; padding: 10px; white-space: normal; overflow: auto; height: 420px;"></div>');
    }
    $('#uploaded-images').html('');
    $.ajax({
        url: '/admin/cms/image/list/',
        type: 'get',
        dataType: 'json',
        success: function (data) {
            $(data.data.paths).each(function () {
                $('#uploaded-images').append(
                    $('<img src="' + this + '" class="uploaded" style="height: 100px; margin-right: 10px; cursor: pointer;" />')
                );
            });
            $('img.uploaded').click(function () {
                editor.insertContent('<img src="' + $(this).attr('src') + '" style="max-width: 100%;" />');
                editor.windowManager.close();
            });
        },
    });
}
