tinymce.PluginManager.add('imageupload', function(editor, url) {
    // Add a button that opens a window
    editor.addButton('imageupload', {
        text: 'Image Upload',
        icon: false,
        onclick: function() {
            // Open window
            editor.windowManager.open({
                title: 'Image Upload',
                body: [],
                width: 800,
                height: 500,
                onsubmit: function(e) {
                    //
                }
            });

            loadUploadedImages(editor);

            $('.mce-container-body.mce-window-body .mce-abs-layout').append(
                $('<div style="float: right; margin: 10px;"><input type="button" id="purge-unused-imgs" value="Purge all unused images" /></div>')
            );
            $('.mce-container-body.mce-window-body .mce-abs-layout').append(
                $('<form id="upload-form" style="padding: 10px;"><input type="file" name="file" /></form>')
            );

            $('#upload-form input[name=file]').change(function () {
                $.ajax({
                    url: '/admin/cms/image/upload/',
                    type: 'post',
                    dataType: 'json',
                    data: new FormData($('#upload-form')[0]),
                    success: function (data) {
                        loadUploadedImages(editor);
                    },
                    cache: false,
                    contentType: false,
                    processData: false
                });
            });

            function purgeAll() {
                $.ajax({
                    url: '/admin/cms/image/purge_all/',
                    type: 'get',
                    dataType: 'json',
                    success: function (data) {
                        console.log(data);
                        var $imgs = $('#uploaded-images img');
                        var paths = data.data.paths;
                        $('img.uploaded').unbind('click');
                        $imgs.each(function () {
                            var src = this.src.match(/http:\/\/[\w\:\-\.]+(\/.*)/)[1];
                            if (paths.indexOf(src) != -1) {
                                $(this).css('border', '3px solid red');
                            } else {
                                $(this).css('opacity', '.2');
                            }
                        });
                        //$('#purge-unused-imgs').attr('disabled', 'disabled');

                        $('<a href="javascript:;" id="cancel-delete">Cancel&nbsp;&nbsp;&nbsp;</a></div>').insertBefore($('#purge-unused-imgs'));

                        $('#purge-unused-imgs').attr('value', 'DELETE ALL HIGHLIGHTED IMAGES!');

                        $('#cancel-delete').click(function () {
                            $('#uploaded-images').html('');
                            loadUploadedImages(editor);
                            $('#purge-unused-imgs').attr('value', 'Purge all unused images');
                            $('#purge-unused-imgs').unbind('click').click(purgeAll);
                            $('#cancel-delete').remove();
                        });
                        $('#purge-unused-imgs').unbind('click').click(function () {
                            $.ajax({
                                url: '/admin/cms/image/purge_all/',
                                type: 'post',
                                dataType: 'json',
                                success: function (data) {
                                    console.log(data.data.removed);
                                    $('#uploaded-images').html('');
                                    loadUploadedImages(editor);
                                    $('#purge-unused-imgs').attr('value', 'Purge all unused images');
                                    $('#purge-unused-imgs').unbind('click').click(purgeAll);
                                    $('#cancel-delete').remove();
                                }
                            });
                        });
                    }
                });
            }

            $('#purge-unused-imgs').click(purgeAll);
        }
    });
});

function loadUploadedImages(editor) {
    if (!$('#uploaded-images').length) {
        $('.mce-container-body.mce-window-body').append('<div id="uploaded-images" style="margin-top: 50px; padding: 10px; white-space: normal; overflow: auto; height: 420px;"></div>');
    }
    $('#uploaded-images').html('');
    $.ajax({
        url: '/admin/cms/image/list/',
        type: 'get',
        dataType: 'json',
        success: function (data) {
            console.log(data);
            $(data.data.paths).each(function () {
                $('#uploaded-images').append($('<div style="margin-top: 20px;">' + this.date + '</div>'));
                $(this.items).each(function () {
                    $('#uploaded-images').append(
                        $('<img src="' + this.path + '" class="uploaded" style="height: 100px; margin-right: 7px; margin-bottom: 7px; border: 3px solid white; cursor: pointer;" title="' + this.date +'" />')
                    );
                });
            });
            $('img.uploaded').click(function () {
                editor.insertContent('<img src="' + $(this).attr('src') + '" style="max-width: 100%;" />');
                editor.windowManager.close();
            });
        },
    });
}
